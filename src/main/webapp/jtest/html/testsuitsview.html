<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>树控件</title>
<meta name="keywords"
	content="免费控件,免费UI控件,免费开源UI,免费开源UI控件,免费开源UI框架,树,tree,动态树,大数据树">
<script src="../../lib/jquery/jquery-1.9.0.min.js"
	type="text/javascript"></script>
<link href="../../lib/ligerUI/skins/Aqua/css/ligerui-all.css"
	rel="stylesheet" type="text/css">
<script src="../../lib/ligerUI/js/core/base.js" type="text/javascript"></script>
<script src="../../lib/ligerUI/js/ligerui.all.js"></script>
<script src="../../jtest/stringutil.js"></script>
<script src="../../jtest/websocket.js" type="text/javascript"></script>
<script src="http://cdn.bootcss.com/sockjs-client/1.1.1/sockjs.min.js"></script>
<script src="http://cdn.bootcss.com/stomp.js/2.3.3/stomp.js"></script>
<script type="text/javascript">
	var testsuiteid = null;
	$(function() {
		testsuiteid = GetQueryString(window.location.search.substr(1),
				"testsuiteId")
		projectid = GetQueryString(window.location.search.substr(1),
				"testsuiteId")
		testsuite = getTreeData()
		contextmenu= $.ligerMenu({
			top : 100,
			left : 200,
			width : 200,
			items : [ {
				text : '删除测试用例',
				click : deltestcase
			}]
		})
		datas = {}
		datas.children = true
		datas.id = testsuite["id"]
		datas.text = testsuite["testsuiteName"]
		$("#testsuitetree").ligerTree({
			nodeWidth : 200,
			data : [ datas ],
			checkbox : true,
			delay : true,
			onExpand : function(node) {
				var datas = getTestCase()
				var manager = $("#testsuitetree").ligerGetTreeManager();
				var childdatas = []
				for ( var i in datas) {
					childdata = {}
					childdata.id = datas[i].id
					childdata.text = datas[i].testcaseName
					childdata.projectId = datas[i].projectId
					childdatas.push(childdata)
				}

				if (datas != undefined) {
					manager.reloadNode(node.target, childdatas)
				}

			},
			onContextmenu : function(node, e) {
				var data = node.data
				contextmenu.show({
					top : e.pageY,
					left : e.pageX
				});
				
			}
		});

		$("#testcasetree").ligerTree({
			nodeWidth : 200,
			data : getProjectTestCase(),
			checkbox : true,
			delay : true
		});

		manager = $("#testsuitetree").ligerGetTreeManager();

		$("#pageloading").hide();
	});
	function getTreeData() {
		var url = "http://localhost:8080/testsuite/gettestsuite?testsuiteId="
				+ testsuiteid
		var data = {};
		$.ajax({
			url : url,
			type : "GET",
			async : false,
			success : function(result) {
				data = result;
			}
		});
		return data
	}
	function getTestCase() {
		var url = "http://localhost:8080/testsuite/gettestcases"
		var data = {};
		$.ajax({
			url : url,
			type : "POST",
			data : testsuite,
			async : false,
			success : function(result) {
				data = result;
			}
		});
		return data

	}

	function getAllTestCase() {
		var url = "http://localhost:8080/testsuite/gettestcases"
		var data = {};
		$.ajax({
			url : url,
			type : "POST",
			data : testsuite,
			async : false,
			success : function(result) {
				data = result;
			}
		});
		return data
	}

	function getProjectTestCase() {
		var url = "http://localhost:8080/testsuite/getprojecttestcase"
		var testdata = []
		$.ajax({
			url : url,
			type : "POST",
			data : testsuite,
			async : false,
			success : function(result) {
				for ( var i in result) {
					var o = {
						"id" : result[i].id,
						"text" : result[i].testcaseName,
					}
					testdata.push(o)
				}
			}
		});
		return testdata
	}
	//添加测试用例
	function addTestCase() {
		manager = $("#testsuitetree").ligerGetTreeManager();
		manager2 = $("#testcasetree").ligerGetTreeManager();
		var checkarray = manager2.getChecked()
		if (checkarray.length == 0) {
			alert("请勾选测试用列")
		} else {
			testcaseIds = JSON.parse(testsuite["testcaseIds"]);
			for ( var i in checkarray) {
				testcaseIds.push(checkarray[i].data.id)
			}
			testsuite["testcaseIds"] = JSON.stringify(testcaseIds)
		}
		//更新到数据库
		updateTestSuite()
		//更新tree1，tree2
		manager.refreshTree()
		manager2.reload()

	}
	//删除测试用例
	function deltestcase() {
		manager = $("#testsuitetree").ligerGetTreeManager();
		manager2 = $("#testcasetree").ligerGetTreeManager();
		var checkarray = manager.getSelected()
		if (checkarray.length == 0) {
			alert("请勾选测试用列")
		} else {
			testcaseIds = JSON.parse(testsuite["testcaseIds"]);
			newids=[]
			for ( var i in testcaseIds) {
				if(checkarray[0].data.id!=testcaseIds[i]){
					newids.push(testcaseIds[i])
				}
			}
			testsuite["testcaseIds"] = JSON.stringify(newids)
		}
		//更新到数据库
		updateTestSuite()
		//更新tree1，tree2
		manager.refreshTree()
		manager2.reload()

	}

	function updateTestSuite() {
		var url = "http://localhost:8080/testsuite/createtestsuite"

		$.ajax({
			url : url,
			type : "POST",
			data : testsuite,
			async : false,
			success : function(result) {
				console.log(result)
			}
		});

	}

	function runtestsuite() {
		var url = "http://localhost:8080/run/runtestsuits"

		$.ajax({
			url : url,
			type : "POST",
			data : {
				userId : uid,
				projectId : projectid,
				testcaseId : testsuite.id
			},
			async : false,
			success : function(result) {
				console.log(result)
			}
		});
	}
</script>
</head>
<body>
	<a class="l-button" onclick="runtestsuite()"
		style="float: left; margin-right: 10px;">运行测试集</a>
	<div class="l-clear"></div>
	<a class="l-button" onclick="addTestCase()"
		style="float: left; margin-right: 10px;">添加测试用例</a>
	<br>


	<br>
	<!-- 带复选框和图标 -->
	<div class="all" style="width: 800px; height: 600px;">
		<div
			style="width: 300px; height: 400px; margin: 10px; margin-right: 1px; float: left; border: 1px solid #ccc; overflow: auto;">
			<ul id="testsuitetree" style="width: 200px;">
		</div>
		<div
			style="width: 300px; height: 400px; margin: 10px; margin-left: 1px; float: left; border: 1px solid #ccc; overflow: auto;">
			<ul id="testcasetree" style="width: 200px; cursor: default;">
		</div>
	</div>

	<div style="display: none"></div>
</body>
</html>